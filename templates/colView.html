<head>
<script type="text/javascript" src="/static/jscript/jquery-1.7.1.min.js"></script>
<script type="text/javascript" src="/static/jscript/schemaAutocomplete.js"></script>
<script type="text/javascript" src="/static/jscript/utilities.js"></script>
<script type="text/javascript" src="/static/jscript/makeDOM.js"></script>


<script type='text/javascript'>
keyStats = 5;
function getKeyStats(){
	var data = {};
	data["dbName"] = "{{db.name}}"
	data["colName"] = "{{col.name}}"
	$.getJSON("/ajax/getkeystats", data, function(data){keyStats = data['stats']; printKeyStats(keyStats)})
}

function printKeyStats(keyStats, div){
	var statsList = makeKeysList(keyStats)
	$("#keyStatsDiv").append(statsList)
} //end printKeyStats

//run when a list item is clicked.  Get's the <field>.<field>... string
// and then adds this string along with value and [equals, exists, ...]
// fields for searching to the appropriate div
function addToCriteria(e){
	keyChain = getKeyChain.apply(this, [e])
	addKeyChainToCriteria(keyChain)
}
//returns a <key>.<key>... structure for the node represented
// by "this" in the list
function getKeyChain(e){
	
	e.stopPropagation()
	keyName = $(this).children(".keyName").html()
	parentList = $($(this).parent()).parent();
	if($(parentList).attr('class') == 'keyListLi'){
		return keyName+"."+getKeyChain.apply(parentList, [e])
	}
	return keyName
	console.log($(parentList).children('.keyName').html())
}

function addKeyChainToCriteria(keyChain){
	newCriteria = document.createElement('div')
	$(newCriteria).append("<span class='field'>"+keyChain+"</span>")
	var logicType = document.createElement('select')
	$(logicType).attr('class', 'logicType')
		var types = ['equals', 'in', 'exists']
		for(var type in types){
			var option = document.createElement('option')
			$(option).html(types[type])
			$(logicType).append(option)
		}
	valueField = document.createElement('input')
	$(valueField).attr('class', 'valueField')
	$(newCriteria).append("<br>")
	$(newCriteria).append(logicType)
	$(newCriteria).append(valueField)
	$("#queryFields").append(newCriteria)
}
//takes in the key stats from the server and makes a DOM HTML list
function makeKeysList(keyStats){
	var list = document.createElement('ul')
	for (var key in keyStats){
		var li = document.createElement('li')
		$(li).attr('class', 'keyListLi')
		$(li).append("<span class=keyName>"+key+"</span> ")
		$(li).append("(<span class=keyCount>"+keyStats[key]['count']+"</span>: ")
		$(li).append("<span class=keyTypes>"+keyStats[key]['types']+"</span>)")
		//$(li).click(function(){console.log($(self).children(".keyName")[0])})
		$(li).click(addToCriteria)
		if(Object.keys(keyStats[key]['subKeys']).length > 0)
			$(li).append(makeKeysList(keyStats[key]['subKeys']))
		$(list).append(li)
	}
	return list
} //end makeKeysList

//takes in a single document and turns it into an expandable DOM HTML list
function makeDocExpandList(document){
	var list = makeUl()
	for (var key in document){
		var val = document[key]
		var li = makeLi()
		if (!isDic(val)) // if it's not dictionary, just print it
			$(li).append(key+': '+val)
		else{ //recurse into it
			$(li).append(key+': ')
			$(li).append(makeDocExpandList(val))
		}
		$(list).append(li)
	}
	return list
}
</script>

<script type='text/javascript'>

	


	$(document).ready(function(){
		getKeyStats()
		
		var haystack = ["ActionScript", "AppleScript", "Asp", "BASIC"];
		makeAutocompleteField('#query', haystack, '#autoSuggestions')
		makeAutocompleteField('#showFields', haystack, '#autoSuggestions')
		
	}) //end document.ready
	function query(){
		var withQuotes = addQuotesToFields($("#query").val())
		console.log("sending: " + withQuotes)
		var queryInputText = "{"+withQuotes + "}"
		var dbName = "{{db.name}}"
		var colName = "{{col.name}}"
		var criteria = {}
		criteria['dbName']=dbName
		criteria['colName']=colName
		criteria['queryText'] = queryInputText
		criteria['selectFields'] = CSV2Array($("#selectFields").val())
		criteria['queryLimit'] = parseInt($("#queryLimit").val())
		console.log(criteria)
		$.ajax({
			type:"POST",
			url:"/ajax/query",
			data:JSON.stringify(criteria),
			success: resultsReceived,
			contentType: "application/json"
		})
		
		function resultsReceived(results){
			console.log("printing results")	
			console.log(results)
			data = results['results']
			$("#queryResults").html("") //clear it
			for(var i=0; i<data.length; i++){
				var document = data[i]
				var newDiv = makeDiv()
				$(newDiv).data('detailsLoaded', false) //have the details already been loaded?
				var newImg = makeImg("/static/images/expandLogo.png")
				$(newImg).attr('height', 15)
				$(newImg).css('float', 'left')
				$(newImg).attr('onclick', "showDetails()")
				
				
				var summary = makeDiv(); $(summary).attr('class', 'summary')
				$(summary).css({'background-color':'#B8B8B8', 'margin-bottom':'5px'})
				$(summary).attr('onclick', "showDetails()")
				$(summary).append(JSON.stringify(document))
				var expandDiv = makeDiv(); $(expandDiv).attr('class', 'expandDetails'); $(expandDiv).css('display', 'none')
				$(newDiv).append(newImg)
				$(newDiv).data('objID', data[i]['_id']['$oid'])
				$(newDiv).append(summary)
				$(newDiv).append(expandDiv)
				$("#queryResults").append(newDiv)
			}
		} // end resultsReceived
		
	} // end query
	
	//takes in the event handler for a clicked "expand" icon and loads (if necessary) then displays the details
	function showDetails(e){
		var sender = (e && e.target) || (window.event && window.event.srcElement);
		var container = $(sender).parent()
		var detailsDiv = $(container).children('.expandDetails')
		objID = $(container).data('objID')
		console.log('obj id is ' + objID)
		if(!$(container).data('detailsLoaded')){ //if the details have not been loaded yet
			loadDocument(detailsDiv, objID)
			container.data('detailsLoaded', true)
		}
		detailsDiv.slideToggle()
		
		
	}
	
	//takes in an objectID (as a string) and returns that document
	function loadDocument(detailsDiv, objID){
		var dbName = "{{db.name}}"
		var colName = "{{col.name}}"
		var criteria = {}
		criteria['dbName']=dbName
		criteria['colName']=colName
		criteria['objID'] = objID
		$.ajax({
			type:"POST",
			url:"/ajax/loadDocument",
			data:JSON.stringify(criteria),
			success: documentReceived,
			contentType: "application/json"
		})
		
		function documentReceived(document){
			$(detailsDiv).append(makeDocExpandList(document['results']))
			
		}
	} // end loadDocument
	
	//takes in a query string and adds to quotes around field names because we assume that fiels are strings.  This assumption is ok because mongodb requires that
	function addQuotesToFields(string){
		newStr = string
		var index = 0
		while(index < newStr.length){
			//find start of field
			while(newStr[index] == ' ' && index < newStr.length)
				index++
			newStr = newStr.substr(0,index)+"'"+newStr.substr(index,newStr.length)
			index++
			//find end of field
			while(newStr[index] != ':' && index < newStr.length)
				index++
			newStr = newStr.substr(0,index)+"'"+newStr.substr(index,newStr.length)
			index++
			while(newStr[index] != ',' && index < newStr.length)
				index++
			index++
		}
		
		return newStr
	}
	
//converts Commas Separated Values to an array
function CSV2Array(string){
	var splitStr = string.split(',')
	var trimmedLst = []
	for(var i=0; i<splitStr.length; i++){
		var trimmed = splitStr[i].trim()
		if(trimmed)
			trimmedLst.push(trimmed)
	}
	return trimmedLst
}

//toggle the expansion and contraction of the key stats div
function toggleExpandKeyStatsDiv(){
	var div = $('#keyStatsDiv')
	var reducedHeight = div.height();
	div.css('height', 'auto')
	var fullHeight = div.height();
	div.height(reducedHeight).animate({height: fullHeight}, 500);
}
	
	

</script>
</head>

<body>
<a href='/'>Home</a> -> <a href="/db/{{db.name}}">{{db.name}}</a>
<h3 style="color:red">NOTE: Only analyzing 100 records to make schema, for efficiency</h3>
Collection: {{col.name}}
<br><br>
This collection has {{col.count()}} entries.

This collection has the following schemas: <br>

<div id="keyStatsDiv" style='height:100px;overflow:hidden;position:relative'>
	<!--<div id='shadowDiv' style="position:absolute;bottom:0;height:3px;width:100%;background-color:orange;box-shadow:0px -10px 0px #000000;"></div>-->
</div>
<a href="javascript:toggleExpandKeyStatsDiv()">Click To Expand</a>
<div id="autoSuggestions"></div>
<input type="text" name="query" placeholder="type query" id="query" style="width:100%;font-size:30px" />
<input type="text" name="selectFields" placeholder="what fields should be shown" id="selectFields", value='gender' style='width:50%;font-size:30px' /><br>
<input type="number" value=5 id='queryLimit'>
<button style="font-size:30px" onclick="query()">Query</button>
<br>
<div id="queryResults"></div>
</body>