<head>
<script type="text/javascript" src="/static/jscript/jquery-1.7.1.min.js"></script>
<script type='text/javascript'>
keyStats = 5;
function getKeyStats(){
	var data = {};
	data["dbName"] = "{{db.name}}"
	data["colName"] = "{{col.name}}"
	$.getJSON("/ajax/getkeystats", data, function(data){keyStats = data['stats']; printKeyStats(keyStats)})
}

function printKeyStats(keyStats, div){
	var statsList = makeKeysList(keyStats)
	$("#keyStatsDiv").append(statsList)
} //end printKeyStats

//run when a list item is clicked.  Get's the <field>.<field>... string
// and then adds this string along with value and [equals, exists, ...]
// fields for searching to the appropriate div
function addToCriteria(e){
	keyChain = getKeyChain.apply(this, [e])
	addKeyChainToCriteria(keyChain)
}
//returns a <key>.<key>... structure for the node represented
// by "this" in the list
function getKeyChain(e){
	
	e.stopPropagation()
	keyName = $(this).children(".keyName").html()
	parentList = $($(this).parent()).parent();
	if($(parentList).attr('class') == 'keyListLi'){
		return keyName+"."+getKeyChain.apply(parentList, [e])
	}
	return keyName
	console.log($(parentList).children('.keyName').html())
}

function addKeyChainToCriteria(keyChain){
	newCriteria = document.createElement('div')
	$(newCriteria).append("<span class='field'>"+keyChain+"</span>")
	var logicType = document.createElement('select')
	$(logicType).attr('class', 'logicType')
		var types = ['equals', 'in', 'exists']
		for(var type in types){
			var option = document.createElement('option')
			$(option).html(types[type])
			$(logicType).append(option)
		}
	valueField = document.createElement('input')
	$(valueField).attr('class', 'valueField')
	$(newCriteria).append("<br>")
	$(newCriteria).append(logicType)
	$(newCriteria).append(valueField)
	$("#queryFields").append(newCriteria)
}
function makeKeysList(keyStats){
	var list = document.createElement('ul')
	for (var key in keyStats){
		var li = document.createElement('li')
		$(li).attr('class', 'keyListLi')
		$(li).append("<span class=keyName>"+key+"</span> ")
		$(li).append("(<span class=keyCount>"+keyStats[key]['count']+"</span>: ")
		$(li).append("<span class=keyTypes>"+keyStats[key]['types']+"</span>)")
		//$(li).click(function(){console.log($(self).children(".keyName")[0])})
		$(li).click(addToCriteria)
		if(Object.keys(keyStats[key]['subKeys']).length > 0)
			$(li).append(makeKeysList(keyStats[key]['subKeys']))
		$(list).append(li)
	}
	return list
}
</script>

<script type='text/javascript'>
	$(document).ready(function(){
		getKeyStats()
		}
	)
	function query(){
		var criteria = $("#queryBar").val()
		var dbName = "{{db.name}}"
		var colName = "{{col.name}}"
		var criteria = {}
		criteria['dbName']=dbName;criteria['colName']=colName;
		criteria['criteria'] = []
		var fields = $("#queryFields").children()
		for(i=0;i<fields.length;i++){
			var fieldName = $(fields[i]).children('.field').html()
			var logicType = $(fields[i]).children('.logicType').val()
			var value = $(fields[i]).children('.valueField').val()
			//console.log("pushing something")
			criteria['criteria'].push({'fieldName':fieldName, 'logicType':logicType, 'value':value})
		}
		$.ajax({
			type:"POST",
			url:"/ajax/query",
			data:JSON.stringify(criteria),
			success: resultsReceived,
			contentType: "application/json"
		})
	} // end query
	
	
function resultsReceived(results){
			console.log(results)
			data = results['results']
			$("#queryResults").html("") //clear it
			for(var i=0; i<data.length; i++){
				newDiv = document.createElement('div')
				$(newDiv).append(JSON.stringify(data[i]))
				$("#queryResults").append(newDiv)
			}
		}
</script>
</head>

<body>
<a href='/'>Home</a> -> <a href="/db/{{db.name}}">{{db.name}}</a>
<h3 style="color:red">NOTE: Only analyzing 100 records to make schema, for efficiency</h3>
Collection: {{col.name}}
<br><br>
This collection has {{col.count()}} entries.

This collection has the following schemas: <br>

<div id="keyStatsDiv">
</div>
<button id="submitQuery" onclick="query()">Search</button>
<div id="queryFields">
</div>

<div id="queryResults">

</div>
</body>